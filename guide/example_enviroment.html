<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example enviroment &mdash; SAPPC 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> SAPPC
            <img src="../_static/SAPPC_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SAPPC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Example enviroment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/guide/example_enviroment.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-enviroment">
<span id="id1"></span><h1>Example enviroment<a class="headerlink" href="#example-enviroment" title="Permalink to this heading"></a></h1>
<p>In this page we show how to create a robotic manipulator enviroment with a reacher task and how to then train it.</p>
<section id="creating-a-robotenv">
<h2>Creating a RobotEnv<a class="headerlink" href="#creating-a-robotenv" title="Permalink to this heading"></a></h2>
<p>The first thing that we need to do is to create a class that inherits from the <cite>RobotBasicEnv</cite> class. To create this file we can copy the <cite>CustomRobotEnv</cite> found in the <cite>templates</cite> folder of the library. Within this class we will be defining the general specifications of the robot like is URDF model, its controllers, the positions where it will be spawned in the Gazebo simulator, among other things. Althought the file contains many functions we only need to focus on the <cite>__init__</cite> function and the <cite>_check_subs_and_pubs_connection</cite> function. The <cite>__init__</cite> function is the one that will be called when we create an instance of the class. The <cite>_check_subs_and_pubs_connection</cite> function can be used to check if the subscribers and publishers are connected to the correct topics.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomRobotEnv</span><span class="p">(</span><span class="n">robot_BasicEnv</span><span class="o">.</span><span class="n">RobotBasicEnv</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define class variables and functions</span>
        <span class="c1"># Initialize parent class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomRobotEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">launch_gazebo</span><span class="p">,</span> <span class="n">gazebo_init_paused</span><span class="p">,</span> <span class="n">gazebo_use_gui</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_subs_and_pubs_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Checks ROS and Gazebo connections</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>In our example for the reacher task an ABB IRB120 is used as the robot. The URDF model, the controllers and the spawn position are defined in the <cite>__init__</cite> function. As we are using MoveIt some additional functions are defined in the <cite>ABBIRB120MoveItEnv</cite> class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ABBIRB120MoveItEnv</span><span class="p">(</span><span class="n">robot_BasicEnv</span><span class="o">.</span><span class="n">RobotBasicEnv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Superclass for all ABB IRB120 environments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new ABBIRB120Env environment.</span>

<span class="sd">        Sensor Topic List:</span>
<span class="sd">        * /joint_states : JointState received for the joints of the robot</span>

<span class="sd">        Actuators Topic List:</span>
<span class="sd">        * MoveIt! : MoveIt! action server is used to send the joint positions to the robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Starting ABBIRB120MoveIt Env&quot;</span><span class="p">)</span>
        <span class="n">ros_gazebo</span><span class="o">.</span><span class="n">gazebo_unpause_physics</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Robot model and controllers parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_in_gazebo</span><span class="o">=</span><span class="s2">&quot;robot1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;/robot1&quot;</span>
        <span class="n">pkg_name</span><span class="o">=</span><span class="s2">&quot;abb_irb120&quot;</span>
        <span class="n">urdf_file</span><span class="o">=</span><span class="s2">&quot;irb120.urdf.xacro&quot;</span>
        <span class="n">urdf_xacro_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;use_pos_ctrls:=true&#39;</span><span class="p">]</span>
        <span class="n">model_pos_x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span> <span class="n">model_pos_y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span> <span class="n">model_pos_z</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">controller_file</span><span class="o">=</span><span class="s2">&quot;irb120_pos_controller.yaml&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;joint_state_controller&quot;</span><span class="p">,</span><span class="s2">&quot;arm120_controller&quot;</span><span class="p">]</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use parameters to allow multiple robots in the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;/ABB_IRB120_Reacher/current_robot_num&#39;</span><span class="p">):</span>
            <span class="n">num_robot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;/ABB_IRB120_Reacher/current_robot_num&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name_in_gazebo</span> <span class="o">=</span> <span class="s2">&quot;robot&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_robot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="s2">&quot;/robot&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_robot</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_robot</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name_in_gazebo</span> <span class="o">=</span> <span class="s2">&quot;robot&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_robot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;/ABB_IRB120_Reacher/current_robot_num&#39;</span><span class="p">,</span> <span class="n">num_robot</span><span class="p">)</span>
        <span class="n">model_pos_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_robot</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">model_pos_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_robot</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">model_pos_z</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set if the controllers in &quot;controller_list&quot; will be reset at the beginning of each episode, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reset_controllers</span><span class="o">=</span><span class="kc">False</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the reset mode of gazebo at the beginning of each episode: 1 is &quot;reset_world&quot;, 2 is &quot;reset_simulation&quot;. Default is 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reset_mode</span><span class="o">=</span><span class="mi">1</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the step mode of Gazebo. 1 is &quot;using ros services&quot;, 2 is &quot;using step function of gazebo&quot;. Default is 1.</span>
<span class="sd">        If using the step mode 2 then set the number of steps of Gazebo to take in each episode. Default is 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step_mode</span><span class="o">=</span><span class="mi">1</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init the parent class with the corresponding variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ABBIRB120MoveItEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>   <span class="n">launch_gazebo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spawn_robot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">model_name_in_gazebo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name_in_gazebo</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">pkg_name</span><span class="o">=</span><span class="n">pkg_name</span><span class="p">,</span>
                    <span class="n">urdf_file</span><span class="o">=</span><span class="n">urdf_file</span><span class="p">,</span> <span class="n">controller_file</span><span class="o">=</span><span class="n">controller_file</span><span class="p">,</span> <span class="n">controller_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_list</span><span class="p">,</span> <span class="n">urdf_xacro_args</span><span class="o">=</span><span class="n">urdf_xacro_args</span><span class="p">,</span>
                    <span class="n">model_pos_x</span><span class="o">=</span><span class="n">model_pos_x</span><span class="p">,</span> <span class="n">model_pos_y</span><span class="o">=</span><span class="n">model_pos_y</span><span class="p">,</span> <span class="n">model_pos_z</span><span class="o">=</span><span class="n">model_pos_z</span><span class="p">,</span>
                    <span class="n">reset_controllers</span><span class="o">=</span><span class="n">reset_controllers</span><span class="p">,</span> <span class="n">reset_mode</span><span class="o">=</span><span class="n">reset_mode</span><span class="p">,</span> <span class="n">step_mode</span><span class="o">=</span><span class="n">step_mode</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define publisher or subscribers as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_state_topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">+</span> <span class="s2">&quot;/joint_states&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_state_topic</span> <span class="o">=</span> <span class="s2">&quot;/joint_states&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;joint_1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;joint_2&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;joint_3&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;joint_4&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;joint_5&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;joint_6&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_state_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_state_topic</span><span class="p">,</span> <span class="n">JointState</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_state_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_state</span> <span class="o">=</span> <span class="n">JointState</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init MoveIt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ros_launch</span><span class="o">.</span><span class="n">ros_launch_from_pkg</span><span class="p">(</span><span class="s2">&quot;abb_irb120_reacher&quot;</span><span class="p">,</span><span class="s2">&quot;moveit_init.launch&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;namespace:=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)])</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s2">&quot;/move_group/trajectory_execution/set_parameters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rostopic</span><span class="o">.</span><span class="n">get_topic_type</span><span class="p">(</span><span class="s2">&quot;/planning_scene&quot;</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rostopic</span><span class="o">.</span><span class="n">get_topic_type</span><span class="p">(</span><span class="s2">&quot;/move_group/status&quot;</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If using the _check_subs_and_pubs_connection method, then un-comment the lines below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_subs_and_pubs_connection</span><span class="p">()</span>

        <span class="c1">#--- Start MoveIt Object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_abb_object</span> <span class="o">=</span> <span class="n">MoveABB</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finished __init__ method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Finished Init of ABBIRB120MoveIt Env&quot;</span><span class="p">)</span>
        <span class="n">ros_gazebo</span><span class="o">.</span><span class="n">gazebo_pause_physics</span><span class="p">()</span>
</pre></div>
</div>
<p>To check if the topics and services are working, we use the <cite>_check_subs_and_pubs_connection</cite> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_check_subs_and_pubs_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to check if the gazebo and ros connections are ready</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_joint_states_ready</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_check_joint_states_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to check if the joint states are received</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ros_gazebo</span><span class="o">.</span><span class="n">gazebo_unpause_physics</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">rostopic</span><span class="o">.</span><span class="n">get_topic_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_state_topic</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Current &quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_state_topic</span> <span class="o">+</span><span class="s2">&quot; READY=&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_state</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
<section id="creating-a-taskenv">
<h2>Creating a TaskEnv<a class="headerlink" href="#creating-a-taskenv" title="Permalink to this heading"></a></h2>
<p>After creating the <cite>RobotEnv</cite> class which contains the general functions for the robot, we create the <cite>TaskEnv</cite> class which contains the specific functions for the task. As a task must always have a robot the <cite>TaskEnv</cite> class inherits from the <cite>RobotEnv</cite> class. Within this class we define the specific functions for the task, like the observation, the reward, the reset, the action space, the observation space, the goal and the termination. To create a file for the task we can copy the template file <cite>CustomTaskEnv</cite> from the <cite>templates</cite> folder.</p>
<p>The template has different functions for the observation, the reward, the reset, the action space, the observation space, the goal and the termination. It will also register the enviroment to the OpenAI Gym environment list so that it can be used as a part of the OpenAI Gym library.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;CustomTaskEnv-v0&#39;</span><span class="p">,</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="s1">&#39;frobs_rl.templates.CustomTaskEnv:CustomTaskEnv&#39;</span><span class="p">,</span>
    <span class="n">max_episode_steps</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">CustomTaskEnv</span><span class="p">(</span><span class="n">CustomRobotEnv</span><span class="o">.</span><span class="n">CustomRobotEnv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom Task Env, use this env to implement a task using the robot defined in the CustomRobotEnv</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describe the task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Starting Task Env&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init super class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomTaskEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the action and observation space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.action_space = spaces.Discrete(n_actions)</span>
        <span class="c1"># self.action_space = spaces.Box(low=0, high=1, shape=(1,), dtype=np.float32)</span>

        <span class="c1"># self.observation_space = spaces.Discrete(n_observations)</span>
        <span class="c1"># self.observation_space = spaces.Box(low=0, high=1, shape=(1,), dtype=np.float32)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define subscribers or publishers as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.pub1 = rospy.Publisher(&#39;/robot/controller_manager/command&#39;, JointState, queue_size=1)</span>
        <span class="c1"># self.sub1 = rospy.Subscriber(&#39;/robot/joint_states&#39;, JointState, self.callback1)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finished __init__ method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Finished Init of Custom Task env&quot;</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------#</span>
    <span class="c1">#   Custom available methods for the CustomTaskEnv      #</span>

    <span class="k">def</span> <span class="nf">_set_episode_init_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to set some parameters, like the position of the robot, at the beginning of each episode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_send_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to send an action to the robot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_get_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get the observation from the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get the reward from the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_if_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to check if the episode is done.</span>

<span class="sd">        If the episode has a success condition then set done as:</span>
<span class="sd">            self.info[&#39;is_success&#39;] = 1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>For our example task, we begin by defining the observation and action space in the <cite>__init__</cite> method, along with initializing the <cite>ABBIRB120MoveItEnv</cite>, which is our <cite>RobotEnv</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ABBIRB120ReacherEnv</span><span class="p">(</span><span class="n">abb_irb120_moveit</span><span class="o">.</span><span class="n">ABBIRB120MoveItEnv</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reacher enviroment for the ABB IRB120 robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Starting ABBIRB120ReacherEnv Task Env&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load YAML param file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ros_params</span><span class="o">.</span><span class="n">ros_load_yaml_from_pkg</span><span class="p">(</span><span class="s2">&quot;abb_irb120_reacher&quot;</span><span class="p">,</span> <span class="s2">&quot;reacher_task.yaml&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the action and observation space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#--- Define the ACTION SPACE</span>
        <span class="c1"># Define a continuous space using BOX and defining its limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_joint_values</span><span class="p">),</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_joint_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1">#--- Define the OBSERVATION SPACE</span>
        <span class="n">observations_high_goal_pos_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">position_goal_max</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_goal_max</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_goal_max</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]]))</span>
        <span class="n">observations_low_goal_pos_range</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">position_goal_min</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_goal_min</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_goal_min</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]]))</span>

        <span class="n">observations_high_vec_EE_GOAL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">observations_low_vec_EE_GOAL</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="c1">#- With Vector from EE to goal, Goal pos and joint angles</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">observations_high_vec_EE_GOAL</span><span class="p">,</span> <span class="n">observations_high_goal_pos_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_joint_values</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">low</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">observations_low_vec_EE_GOAL</span><span class="p">,</span>  <span class="n">observations_low_goal_pos_range</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">min_joint_values</span><span class="p">,</span> <span class="p">])</span>

        <span class="c1">#--- Observation space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1">#-- Action space for sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">observations_low_goal_pos_range</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">observations_high_goal_pos_range</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define subscribers or publishers as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">goal_subs</span>  <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;goal_pos&quot;</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">ros_node</span><span class="o">.</span><span class="n">ros_node_from_pkg</span><span class="p">(</span><span class="s2">&quot;abb_irb120_reacher&quot;</span><span class="p">,</span> <span class="s2">&quot;pos_publisher.py&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pos_publisher&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s2">&quot;set_init_point&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_init_goal_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s2">&quot;set_init_point&quot;</span><span class="p">,</span> <span class="n">SetLinkState</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init super class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ABBIRB120ReacherEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finished __init__ method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Finished Init of ABBIRB120ReacherEnv Task Env&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>After defining the observation and action space we define the methods to execute an action and get the observation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_send_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The action are the joint positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;=== Action: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>

    <span class="c1">#--- Make actions as deltas</span>
    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_values</span> <span class="o">+</span> <span class="n">action</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_joint_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_joint_values</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">movement_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_joints</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">movement_result</span><span class="p">:</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Movement_result failed with the action of : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It returns the position of the EndEffector as observation.</span>
<span class="sd">    And the distance from the desired point</span>
<span class="sd">    Orientation for the moment is not considered</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#--- Get Current Joint values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">joint_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_joint_angles</span><span class="p">()</span>

    <span class="c1">#--- Get current goal</span>
    <span class="n">current_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span>

    <span class="c1">#--- Get EE position</span>
    <span class="n">ee_pos_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span> <span class="c1"># Get a geometry_msgs/PoseStamped msg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ee_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ee_pos_v</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ee_pos_v</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">ee_pos_v</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>

    <span class="c1">#--- Vector to goal</span>
    <span class="n">vec_EE_GOAL</span> <span class="o">=</span> <span class="n">current_goal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_pos</span>
    <span class="n">vec_EE_GOAL</span> <span class="o">=</span> <span class="n">vec_EE_GOAL</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_EE_GOAL</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
        <span class="n">vec_EE_GOAL</span><span class="p">,</span>             <span class="c1"># Vector from EE to Goal</span>
        <span class="n">current_goal</span><span class="p">,</span>            <span class="c1"># Position of Goal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_values</span>        <span class="c1"># Current joint angles</span>
        <span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;OBSERVATIONS====&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
<p>Then we proceed by defining the reward method and the method for episode termination.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a success of the execution of the action</span>
<span class="sd">    Calculate the reward: binary =&gt; 1 for success, 0 for failure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#--- Get current EE pos</span>
    <span class="n">current_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_pos</span> <span class="c1"># If using ARRAY</span>

    <span class="c1">#- Init reward</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#- Check if the EE reached the goal</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_if_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movement_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dynamic</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;SUCCESS Reached a Desired Position!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;is_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1">#- Success reward</span>
        <span class="n">reward</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_goal_reward</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#- Distance from EE to Goal reward</span>
        <span class="n">dist2goal</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">euclidean</span><span class="p">(</span><span class="n">current_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
        <span class="n">reward</span> <span class="o">+=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_dist_reward</span><span class="o">*</span><span class="n">dist2goal</span>

        <span class="c1">#- Constant reward</span>
        <span class="n">reward</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_reward</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pub_marker</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_marker</span><span class="p">)</span>

    <span class="c1">#- Check if joints are in limits</span>
    <span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_values</span><span class="p">)</span>
    <span class="n">min_joint_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_joint_values</span><span class="p">)</span>
    <span class="n">max_joint_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_joint_values</span><span class="p">)</span>
    <span class="n">in_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">joint_angles</span><span class="o">&lt;=</span><span class="p">(</span><span class="n">min_joint_values</span><span class="o">+</span><span class="mf">0.0001</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">joint_angles</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">max_joint_values</span><span class="o">-</span><span class="mf">0.0001</span><span class="p">))</span>
    <span class="n">reward</span> <span class="o">+=</span> <span class="n">in_limits</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits_reward</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;REWARD&gt;&gt;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">reward</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">reward</span>

<span class="k">def</span> <span class="nf">_check_if_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the EE is close enough to the goal</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#--- Get current EE based on the observation</span>
    <span class="n">current_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_pos</span> <span class="c1"># If using ARRAY</span>

    <span class="c1">#--- Function used to calculate</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_if_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movement_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Reached a Desired Position!&quot;</span><span class="p">)</span>

    <span class="c1">#--- If the position is dynamic the episode is never done</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dynamic</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important to say that we can add as many methods to the class as we require.</p>
</div>
<p>Finally, we add the register function at the beginning of the file to register the enviroment within the OpenAI Gym library.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ABBIRB120ReacherEnv-v0&#39;</span><span class="p">,</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="s1">&#39;abb_irb120_reacher.task_env.irb120_reacher:ABBIRB120ReacherEnv&#39;</span><span class="p">,</span>
    <span class="n">max_episode_steps</span><span class="o">=</span><span class="mi">10000</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="setting-the-training-parameters">
<h2>Setting the training parameters<a class="headerlink" href="#setting-the-training-parameters" title="Permalink to this heading"></a></h2>
<p>After we have defined the Task enviroment we need to create a YAML file with the training parameters. Based on the algorithm that we choose we can copy the template file from the <cite>config</cite> folder of <cite>FRobs_RL</cite> and modify it.</p>
<p>In this example we will use the <cite>TD3</cite> algorithm and we will set the number of training steps to 100000. We will also set a saving frequency of the model, so the trained model is being constantly saved and not only at the end of the training. The saving frequency will be set to 5000 steps. We will set the log folder to <cite>TD3_New</cite>, in this folder the tensorboard logs will be saved.Finally, we can set parameters to use a custom policy architecture and the <cite>TD3</cite> specific parameters. After all the changes are made to the template the file will look as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model_params</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Training</span><span class="w"></span>
<span class="w">    </span><span class="nt">training_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000</span><span class="w">      </span><span class="c1"># The number of training steps to perform</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Save params</span><span class="w"></span>
<span class="w">    </span><span class="nt">save_freq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"></span>
<span class="w">    </span><span class="nt">save_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">td3_model</span><span class="w"></span>
<span class="w">    </span><span class="nt">trained_model_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trained_model</span><span class="w"></span>
<span class="w">    </span><span class="nt">save_replay_buffer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Load model params - Used to load a trained model and continue training</span><span class="w"></span>
<span class="w">    </span><span class="nt">load_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>
<span class="w">    </span><span class="nt">model_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trained_model_01_09_2021_10_11_11</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Logging parameters</span><span class="w"></span>
<span class="w">    </span><span class="nt">log_folder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TD3_New</span><span class="w"></span>
<span class="w">    </span><span class="nt">log_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"> </span><span class="c1"># The number of episodes between logs</span><span class="w"></span>
<span class="w">    </span><span class="nt">reset_num_timesteps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"> </span><span class="c1"># If true, will reset the number of timesteps to 0 every training</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Use custom policy - Only used when new model is created</span><span class="w"></span>
<span class="w">    </span><span class="nt">use_custom_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>
<span class="w">    </span><span class="nt">policy_params</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">net_arch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">400</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">300</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># List of hidden layer sizes</span><span class="w"></span>
<span class="w">        </span><span class="nt">activation_fn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">relu</span><span class="w">  </span><span class="c1"># relu, tanh, elu or selu</span><span class="w"></span>
<span class="w">        </span><span class="nt">features_extractor_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FlattenExtractor</span><span class="w"> </span><span class="c1"># FlattenExtractor, BaseFeaturesExtractor or CombinedExtractor</span><span class="w"></span>
<span class="w">        </span><span class="nt">optimizer_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Adam</span><span class="w"> </span><span class="c1"># Adam, Adadelta, Adagrad, RMSprop or SGD</span><span class="w"></span>

<span class="w">    </span><span class="c1"># UseAction noise</span><span class="w"></span>
<span class="w">    </span><span class="nt">use_action_noise</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"> </span><span class="c1"># For now only Gaussian noise is supported</span><span class="w"></span>
<span class="w">    </span><span class="nt">action_noise</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">mean</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"></span>
<span class="w">        </span><span class="nt">sigma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span><span class="w"></span>

<span class="w">    </span><span class="c1"># TD3 parameters</span><span class="w"></span>
<span class="w">    </span><span class="nt">td3_params</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span><span class="w"></span>
<span class="w">        </span><span class="nt">buffer_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000000</span><span class="w"></span>
<span class="w">        </span><span class="nt">learning_starts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">        </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">        </span><span class="nt">tau</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.005</span><span class="w"></span>
<span class="w">        </span><span class="nt">gamma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.99</span><span class="w"></span>
<span class="w">        </span><span class="nt">gradient_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1</span><span class="w"></span>
<span class="w">        </span><span class="nt">policy_delay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="w">        </span><span class="nt">target_policy_noise</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w"></span>
<span class="w">        </span><span class="nt">target_noise_clip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w"></span>
<span class="w">        </span><span class="nt">train_freq</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">freq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">        </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">step</span><span class="w">  </span><span class="c1"># episode or step</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="training-the-model">
<h2>Training the model<a class="headerlink" href="#training-the-model" title="Permalink to this heading"></a></h2>
<p>Finally, we will need to create a simple script to train the model which calls the <cite>train</cite> function of the <cite>ABBIRB120ReacherEnv</cite> class and uses the <cite>TD3</cite> algorithm with the parameters defined in the YAML file.</p>
<p>In the following script, the Gazebo simulator is launched, then the environment is created and some wrappers are applied to the environment. The environment is then trained using the <cite>TD3</cite> algorithm with the parameters defined in the YAML file. And finally, the trained model is saved.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

<span class="c1"># Kill all processes related to previous runs</span>
<span class="n">ros_node</span><span class="o">.</span><span class="n">ros_kill_all_processes</span><span class="p">()</span>

<span class="c1"># Launch Gazebo</span>
<span class="n">ros_gazebo</span><span class="o">.</span><span class="n">launch_Gazebo</span><span class="p">(</span><span class="n">paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Start node</span>
<span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Start&quot;</span><span class="p">)</span>
<span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;train_irb120_reacher&#39;</span><span class="p">)</span>

<span class="c1"># Launch the task environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;ABBIRB120ReacherEnv-v0&#39;</span><span class="p">)</span>

<span class="c1">#--- Normalize action space</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">NormalizeActionWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1">#--- Normalize observation space</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">NormalizeObservWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1">#--- Set max steps</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">TimeLimitWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="c1">#--- Set the save and log path</span>
<span class="n">rospack</span> <span class="o">=</span> <span class="n">rospkg</span><span class="o">.</span><span class="n">RosPack</span><span class="p">()</span>
<span class="n">pkg_path</span> <span class="o">=</span> <span class="n">rospack</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;abb_irb120_reacher&quot;</span><span class="p">)</span>

<span class="c1">#-- TD3</span>
<span class="n">save_path</span> <span class="o">=</span> <span class="n">pkg_path</span> <span class="o">+</span> <span class="s2">&quot;/models/static_reacher/td3/&quot;</span> <span class="c1"># Path where the model will be saved</span>
<span class="n">log_path</span> <span class="o">=</span> <span class="n">pkg_path</span> <span class="o">+</span> <span class="s2">&quot;/logs/aux/td3/&quot;</span>               <span class="c1"># Path where the logs will be saved</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">TD3</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">config_file_pkg</span><span class="o">=</span><span class="s2">&quot;abb_irb120_reacher&quot;</span><span class="p">,</span> <span class="n">config_filename</span><span class="o">=</span><span class="s2">&quot;td3_aux.yaml&quot;</span><span class="p">)</span>

<span class="c1">#-- Train the model and save it</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">close_env</span><span class="p">()</span>

<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, UNAL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>